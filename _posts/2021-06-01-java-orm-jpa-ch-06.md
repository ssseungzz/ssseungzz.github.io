---
title: "JPA 뽀개기 - 다양한 연관관계 매핑"
categories:
  - Develop
tags:
  - jpa
  - java
toc: true
toc_label: "Contents"
toc_sticky: true
---

### 6.  다양한 연관관계 매핑

연관관계를 매핑할 때 고려해야 할 점

* 다중성: 다대일(`@ManyToOne`), 일대다(`@OneToMany`), 일대일(`@OneToOne`), 다대다(`@ManyToMany`)
  * 왼쪽을 연관관계의 주인이라 정함
* 단방향, 양방향
* 연관관계의 주인: 두 객체 연관관계 중 하나를 정해서 데이터베이스 외래 키를 관리 == 연관관계의 주인



#### 다대일

* 데이터베이스 테이블의 일, 다 관계에서 외래 키는 항상 다쪽에 있다. 따라서 객체 양방향 관계에서 연관관계의 주인은 항상 다쪽이다. (ex - 도서관 회원과 대출 도서)

##### 다대일 단방향

* 다쪽에서 일쪽을 참조하는 관계만 존재
  * 반대쪽에서는 상대방을 참조 불가
  * 참조 필드를 외래 키와 매핑해서 참조 필드로 테이블의 외래 키 관리

##### 다대일 양방향

* 양방향은 외래 키가 있는 쪽이 연관관계의 주인
  * 다쪽에 외래 키가 있으므로 다쪽이 연관관계의 주인이 된다. JPA는 외래 키를 관리할 때 연관관계의 주인만 사용한다. 주인이 아닌 쪽은 조회를 위한 JPQL이나 객체 그래프를 탐색할 때 사용한다.
  * 양방향 연관관계는 항상 서로 참조해야 한다. 이를 위해서는 연관관계 편의 메소드를 작성하는 것이 좋다. 편의 메소드는 한 곳에만 작성하거나 양쪽 다 작성할 수 있는데 양쪽에 다 작성하면 무한 루프에 빠지지 않도록 주의가 필요하다.



#### 일대다

##### 일대다 단방향

* 예를 들어 하나의 팀은 여러 회원을 참조할 수 있는데 이런 관계를 일대다 관계라 한다. 그리고 팀은 회원들을 참조하지만 반대로 회원은 팀을 참조하지 않으면 둘의 관계는 단방향이다.
* 보통 자신이 매핑한 테이블의 외래 키를 관리하는데 이 매핑은 반대쪽 테이블에 있는 외래 키를 관리한다.
  * 일대다 관계에서 외래 키는 항상 다쪽 테이블에 있기 때문이다.
* 일대다 단방향 관계를 매핑할 때는 `@JoinColumn`을 명시해야 한다. 그렇지 않으면 JPA는 연결 테이블을 중간에 두고 연관관계를 관리하는 조인 테이블 전략을 기본으로 사용한다.
* 일대다 단방향 매핑은 매핑한 객체가 관리하는 외래 키가 다른 테이블에 있으므로 연관관계 처리를 위한 UPDATE SQL을 추가로 실행해야 하는 단점이 있다.
  * 회원을 생성하고 팀을 생성해서 팀에 회원을 추가하고 영속성 컨텍스트에 저장하면 팀 테이블에 INSERT, 회원 테이블에 UPDATE(외래 키)가 발생한다.
  * 따라서 다대일 양방향 매핑이 권장된다.

##### 일대다 양방향

* 일대다 양방향 매핑은 존재하지 않고 다대일 양방향 매핑을 사용해야 한다.
* 양방향 매핑에서 `@OneToMany`는 연관관계의 주인이 될 수 없다.
  * 관계형 데이터베이스의 특성상 일대다, 다대일 관계는 항상 다쪽에 외래 키가 있으므로 `@OneToMany`, `@ManyToOne` 중에 연관관계의 주인은 항상 다쪽이 된다. 이런 이유로 `@ManyToOne`에는 `mappedBy` 속성이 없다.
* 일대다 양방향 매핑이 완전히 불가능한 것은 아니며, 일대다 단방향 매핑 반대편에 같은 외래 키를 사용하는 다대일 단방향 매핑을 읽기 전용으로 추가하면 된다.
  * 같은 외래 키 컬럼을 매핑하면서 같은 키를 관리하므로 반대편인 다대일 쪽은 읽기만 가능하게 한다.



#### 일대일

* 일대일 관계는 그 반대도 일대일 관계다.
* 주 테이블이나 대상 테이블 중 어느 곳이나 외래 키를 가질 수 있다.
  * 주 객체가 대상 객체를 참조ㅗ하는 것처럼 주 테이블에 외래 키를 두고 대상 테이블을 참조할 수 있다. 외래 키를 객체 참조와 비슷하게 사용할 수 있다.
  * 대상 테이블에 외래 키를 두는 경우 테이블 관계를 일대일에서 일대다로 변경할 때 테이블 구조를 그대로 유지할 수 있다.

##### 주 테이블에 외래 키

* 일대일 관계이므로 객체 매핑에 `@OneToOne`을 사용한다. 데이터베이스에는 외래 키에 유니크 제약 조건을 추가하도록 한다.
* 반대 방향을 추가하면 양방향 관계가 된다. 양방향이므로 연관관계의 주인을 정해야 하는데 주 테이블이 외래 키를 가지고 있으므로 주 테이블에 해당하는 엔티티에 있는 필드가 연관관계의 주인이 된다.

##### 대상 테이블에 외래 키

* 대상 테이블에 외래 키가 있는 단방향 관계는 JPA에서 지원하지 않는다.

![](https://media.vlpt.us/post-images/conatuseus/876762f0-0b8f-11ea-ab7d-d93b128a9cd6/image.png)

* 일대일 테이블에서 대상 테이블에 외래 키를 두고 싶은 경우 양방향으로 매핑한다.
* 프록시를 사용할 때 외래 키를 직접 관리하지 않는 일대일 관계는 지연 로딩으로 설정해도 즉시 로딩된다. 



#### 다대다

* 관계형 데이터베이스는 정규화된 테이블 두 개로 다대다 관계를 표현할 수 없다.

  * 보통 다대다 관계를 일대다, 다대일 관계로 풀어내는 연결 테이블을 사용한다.

  * 그런데 객체는 테이블과 다르게 객체 두 개로 다대다 관계를 만들 수 있다. `@ManyToMany`를 사용하면 다대다 관계를 편리하게 매핑할 수 있다.

##### 다대다: 단방향

* `@ManyToMany`와 `@JoinTable`을 사용해서 연결 테이블을 바로 매핑할 수 있다. 두 엔티티를 연결하는 엔티티 없이 매핑을 완료할 수 있는 것이다.
  * `@JoinTable`: 연결 테이블을 지정한다.
  * `@JoinTable.joinColumns`: 현재 방향 엔티티와 매핑할 조인 컬럼 정보를 지정한다.
  * `@JoinTable.inverseJoinColumns`: 반대 방향 엔티티와 매핑할 조인 컬럼 정보를 지정한다.
* 데이터베이스 테이블에서 다대다 관계를 일대다, 다대일로 풀어내기 위해 필요한 연결 테이블을 지정하고, 현재 엔티티와 매핑할 조인 컬럼과 상대편 엔티티와 매핑할 조인 컬럼 정보를 지정하면 연결 테이블에 해당하는 엔티티를 만들 필요 없이 바로 매핑할 수 있다.
  * 실제 SQL도 연결 테이블과 대상 테이블을 조인한다.

##### 다대다: 양방향

* 다대다 매핑이므로 역방향도 `@ManyToMany`를 사용하고 양쪽 중 원하는 곳에 `mappedBy`로 연관관계의 주인을 지정한다.
* 양방향 연관관계는 연관관계 편의 메소드를 추가해서 관리하는 것이 편리하다.

##### 다대다: 매핑의 한계와 극복, 연결 엔티티 사용

* `@ManyToMany`를 사용하면 연결 테이블을 자동으로 처리해 주므로 편리하지만 연결 테이블에 조인 컬럼 외에 추가적인 컬럼이 더 필요하다면 더 이상 사용할 수 없다.
  * 왜냐하면 컬럼이 추가되었을 때 양쪽 엔티티에서 추가한 컬럼을 매핑할 수 없기 때문이다.
  * 따라서 연결 테이블을 매핑하는 연결 엔티티를 만들고 이곳에 추가한 컬럼들을 매핑해야 한다.
  * 그리고 엔티티 간의 관계도 테이블 관계처럼 다대다에서 일대다, 다대일 관계로 풀어야 한다.
* 연결 테이블은 기본 키를 매핑하는 `@Id`와 외래 키를 매핑하는 `@JoinColumn`을 동시에 사용해서 기본 키 + 외래 키를 한 번에 매핑할 수 있다.
  * `@IdClass`를 사용해서 복합 기본 키를 매핑할 수 있다.
* 연결 테이블은 기본 키가 여러 개로 이루어진 복합 기본 키인데, JPA에서 복합 (기본) 키를 사용하려면 별도의 식별자 클래스를 만들고 엔티티에 `@IdClass`를 사용해서 식별자 클래스를 지정하면 된다.
* 복합 키를 위한 식별자 클래스는 아래와 같은 특징이 있다.
  * 복합 키는 별도의 식별자 클래스로 만들어야 한다.
  * `Serializable`을 구현해야 한다.
  * `equals`와 `hashCode` 메소드를 구현해야 한다.
  * 기본 생성자가 있어야 한다.
  * 식별자 클래스는 `public`이어야 한다.
  * `@IdClass`를 사용하는 방법 외에 `@EmbeddedId`를 사용하는 방법도 있다.
* 부모 테이블의 기본 키를 받아서 자신의 기본 키 + 외래 키로 사용하는 것을 식별 관계라고 한다.
  * 연결 테이블은 연결하고자 하는 테이블의 기본 키를 받아서 자신의 기본 키로 사용함과 동시에 해당 테이블과의 관계를 위한 외래 키로 사용한다. 
  * 또 식별자 클래스로 두 기본 키를 묶어서 복합 기본 키로 사용한다. - 식별자 클래스로 엔티티를 조회한다.

##### 다대다: 새로운 기본 키 사용

* 복합 키를 사용하려면 식별자 클래스도 만들어야 하는 등 처리할 일이 많아지므로 비교적 간단한 방법으로 데이터베이스에서 자동으로 생성해 주는 대리 키를 `Long` 값으로 사용할 수 있다.
  * 간편하고 비즈니스에 의존하지 않는다.

##### 다대다 연관관계 정리

다대다 관계를 일대다, 다대일 관계로 풀어내기 위해 연결 테이블을 만들 때 식별자를 구성하는 두 가지 방식이 있다.

* 식별 관계: 받아온 식별자를 기본 키 + 외래 키로 사용
* 비식별 관계: 받아온 식별자는 외래 키로만 사용하고 새로운 식별자 추가