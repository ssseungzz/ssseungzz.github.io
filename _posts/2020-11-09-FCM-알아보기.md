---
title: FCM에 대해 알아보기
categories:
  - Develop
tags:
  - firebase
toc: true
toc_label: "Contents"
toc_sticky: true
---

### FCM?

* **Firebase Cloud Messaging**의 약자로 무료로 메시지를 안정적으로 전송할 수 있는 교차 플랫폼 메시징 솔루션이다.



### 왜 사용할까?

* Push 메시지를 보내기 위해 iOS, Android, Web 등 각 플랫폼 환경별로 개발할 필요가 없다.
* 교차 플랫폼 메시징 솔루션이기 때문에 플랫폼에 종속되지 않고 메시지를 전송할 수 있다.
* 그렇다면 왜 서버에서 직접 로직을 처리하지 않고 클라우드 메시징 서비스를 이용할까?
  * A가 B에게 메시지를 전달하기 위해 애플리케이션 열어 메시지를 보내면 A의 메시지는 해당 애플리케이션의 서버를 거쳐 B에게 도달한다.
  * A -> 애플리케이션 서버 -> B
  * 애플리케이션을 통해 서비스를 제공하는 회사에서 B에게 마케팅 메시지를 보내기 위해 애플리케이션 서버를 통해 B에게 메시지를 보낸다.
  * 애플리케이션 서버 -> B
  * 이 두 상황에 대해 B가 실시간으로 메시지를 받기 위해서는 서버에 계속 접속해 있어야 하는데, 이는 많은 배터리와 네트워크를 사용한다
  * 클라우드 메시징 서비스를 이용하면 메시징 서버를 중간에 통함으로써 낮은 배터리와 네트워크 사용만으로 메시지를 실시간으로 송수신 처리 할 수 있다.
  * A -> 애플리케이션 서버 -> 클라우드 메시징 서버 -> B와 같은 형태가 된다.



### 특징

* 메시지 타입

  * 알림 메시지와 데이터 메시로 구분할 수 있다. 보통 혼용해서 사용된다.

|  메시지 종류  | 알림 가능 여부 | 알림 저장 개수 |     알림 처리 방법     |
| :-----------: | :------------: | :------------: | :--------------------: |
|  알림 메시지  |      가능      |   여러 알림    |  앱이 백그라운드일 때  |
| 데이터 메시지 |      가능      |      1개       | 앱이 포어그라운드일 때 |



* 타겟팅
  * 단일 기기, 기기 그룹, 주제를 구독한 기기 3가지 방식으로 클라이언트 앱에 메시지를 배포할 수 있다.

|   종류    | 대상 수 |          설명           |
| :-------: | :-----: | :---------------------: |
| 단일 기기 |   1개   |       하나의 기기       |
| 기기 그룹 |  20개   | 알림 키에 허용되는 그룹 |
| 주제 구독 | 1000개  | 등록 토큰에 구독된 기기 |

* 클라이언트 앱에서 메시지 전송



### 그 외의 특징

* 메시지 종류

  * 비축소형 메시지: 모든 메시지가 클라이언트 앱에서 중요하므로 모두 전송되어야 한다. 알림 메시지를 제외한 모든 메시지가 기본적으로 비축소형이다.

  * 축소형 메시지: 클라이언트 앱과 관련 없는 이전 관련 메시지를 렌더링하는 새로운 메시지가 있으면 FCM이 이전 메시지를 대체한다. 동기화 전송 또는 기한이 지난 알림 메시지를 예로 들 수 있다. `collapse_key` 매개 변수를 설정할 수 있다.

* 사용자 인증 정보

  * 발신자 ID: Firebase 프로젝트를 만들 때 생성되는 고유한 숫자 값으로 Firebase 콘솔 창의 클라우드 메시징 탭에서 확인할 수 있다. 발신자 ID는 클라이언트 앱에 메시지를 보낼 수 있는 각 앱 서버를 식별하는 데에 사용된다.
  * 서버 키: 앱 서버가 Firebase 클라우드 메시징을 통한 메시지 전송과 같은 Google 서비스에 액세스할 수 있도록 인증하는 서버 키이다. Firebase 프로젝트를 만들 때 서버 키를 부여받는다.
  * 등록 토큰: 각 클라이언트 앱 인스턴스 용으로 FCM SDK에서 생성하는 ID이다. 단일 기기 및 기기 그룹 메시징에 필요하다. 등록 토큰은 비밀로 유지되어야 한다.



### 동작 원리

* 송신자, FCM Backend 서버, 수신자로 구분한다.

![](https://user-images.githubusercontent.com/33312179/80870392-1d942600-8ce1-11ea-8070-125a69022d48.png)

* 송신자는 주로 앱 서버, HTTP 프로토콜을 사용하는 서버, Firebase용 Cloud 함수, Firebase Console GUI 등 메시지를 작성, 타겟팅, 전송할 수 있는 신뢰할 수 있는 환경이 된다.
* 수신자는 iOS, Android, 웹 등의 클라이언트 앱이 될 수 있다.
* FCM Backend 서버는 실질적으로 앱 서버의 요청을 받아서 메시지를 처리하는 서버에 해당된다.

![](https://user-images.githubusercontent.com/33312179/80870526-f8ec7e00-8ce1-11ea-90d0-d3e474d0218d.png)

* HTTP 프로토콜을 사용하는 경우 처리되는 과정은 아래와 같다.
  * 앱 서버에서 FCM Backend 서버에 클라이언트 앱에 보내고자 하는 메시지를 담은 정보, 서버의 인증 정보, 클라이언트 토큰을 담아 HTTP POST 요쳥을 보낸다.
  * 요청을 받은 FCM Backend 서버는 요청을 통해 받은 메시지의 이상 유무에 따라 앱 서버에 적절한 응답을 보낸다.
  * 이후 FCM Backend 서버에서 여러 가지를 고려하여 메시지를 클라이언트 앱에 보낸다.
  * 클라이언트 앱에서는 받은 메시지를 적절하게 처리하고 응답 메시지를 FCM Backend 서버로 보낸다.
* 이때, 메시지를 수신할 클라이언트는 자신의 정보를 FCM Backend 서버에 등록해야 한다.
  * 클라이언트는 자신의 정보(토픽, 디바이스 정보)를 FCM Backend 서버에 등록해야 한다.
  * 메시지를 전송할 주체(앱 서버 등)는 등록된 정보를 획득해야 하고, 해당 정보로 다운 스트림 메시지를 전송한다.



### FCM Backend 서버와 통신을 위한 앱 서버의 옵션

* FCM Backend 서버와 상호 작용할 방법을 선택해야 한다.

* Firebase Admin SDK
  * FCM에서 가장 권장하는 옵션으로 여러 프로그래밍 언어를 지원한다.
  * 기기에서 주제 구독 및 구독 취소가 가능하고, 다양한 타겟 플랫폼에 맞는 메시지 페이로드를 구성한다.
  * 초기화 작업 후 인증 처리는 자동으로 수행해 준다.
* FCM HTTP v1 API
  * 가장 최신 프로토콜로 안전한 승인과 유연한 교차 플랫폼 메시징 기능을 제공한다.
* 기존 HTTP 프로토콜
* XMPP 서버 프로토콜
  * 클라이언트 애플리케이션에서 업스트림 메시징을 사용하려면 이 옵션을 선택해야 한다.



### FCM을 사용하기 위한 서버 환경의 구성

* FCM Backend 서버와 통신을 위한 애플레케이션 서버를 구축하기 위해서는 아래의 규칙을 지켜야 한다.
  * FCM Backend 서버에 FCM에서 지정한 형식의 메시지 요청을 보낼 수 있어야 한다.
  * 지수 백오프를 사용하여 요청을 처리하고 다시 보낼 수 있어야 한다.
  * 서버 승인 사용자의 인증 정보와 클라이언트의 등록 토큰을 안전하게 저장할 수 있어야 한다.
    * 서버 승인 사용자의 인증 정보: 메시지를 보낼 앱 서버가 인증된 서버라는 것을 증명한다.
    * 클라이언트의 등록 토큰: 메시지를 보내고자 하는 디바이스의 정보