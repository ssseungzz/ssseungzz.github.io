---
title: "2024 년 3 월 23 일 TIL"
categories:
  - TIL
tags:
toc: true
toc_label: "Contents"
toc_sticky: true

---

#### 오늘 한 일

* 이펙티브 자바 아이템 87(커스텀 직렬화 형태를 고려해 보라) 읽기
  * 먼저 고민해 보고 괜찮다고 판단될 때(객체의 물리적 표현과 논리적 내용이 같은 경우 등)만 기본 직렬화 형태를 사용하자. 그렇지 않으면 커스텀 직렬화 형태를 고안하자. 기본 직렬화 형태가 적합하다고 결정했더라도 불변식 보장과 보안을 위해 `readObject` 메서드를 제공해야 할 때가 많다. 객체의 물리적 표현과 논리적 표현의 차이가 클 때 기본 직렬화 형태를 사용하면 공개 API가 현재의 내부 표현 방식에 영구히 묶이며, 너무 많은 공간을 차지하거나 시간이 너무 많이 걸릴 수 있고, 스택 오버플로를 일으킬 수 있다. 해당 객체의 논리적인 상태와 무관한 필드라고 확신할 때만 `transient` 한정자를 생략해야 한다. 기본 직렬화 사용 여부와 관계없이 객체의 전체 상태를 읽는 메서드에 적용해야 하는 동기화 매커니즘을 직렬화에도 적용해야 한다. 어떤 직렬화 형태를 택하든 직렬화 가능 클래스 모두에 직렬 버전 UID를 명시적으로 부여하자. (호환성 문제 방지!)

* 이펙티브 자바 아이템 88(`readObject` 메서드는 방어적으로 작성하라) 읽기

  * `readObject` 메서드를 작성할 때는 `public` 생성자를 작성하듯이 해야 한다. 어떤 바이트 스트림이 넘어오더라도 유효한 인스턴스를 만들어 내야 하며, 바이트 스트림이 진짜 직렬화된 인스턴스라도 가정해서는 안 된다. `private` 이어야 하는 객체 참조 필드는 각 필드가 가리키는 객체를 방어적으로 복사하자. 불변 클래스 내의 가변 요소가 여기 속한다. 모든 불변식을 검사하여 어긋나는 게 발견되면 `InvalidObjectException`을 던지자. 방어적 복사 다음에는 반드시 불변식 검사가 뒤따라야 한다. 역직렬화 후 객체 그래프 전체의 유효성을 검사해야 한다면 `ObjectInputValidation` 인터페이스를 사용하자. 직접적이든 간접적이든 재정의할 수 있는 메서드는 호출하지 말자.

* 이펙티브 자바 아이템 89(인스턴스 수를 통제해야 한다면 `readResolve`보다는 열거 타입을 사용하라)

  * 불변식을 지키기 위해 인스턴스를 통제해야 한다면 가능한 한 열거 타입을 사용하자. 여의치 않은 상황에서 직렬화와 인스턴스 통제가 모두 필요하다면 `readResolve` 메서드를 작성해 넣어야 하고, 그 클래스에서 모든 참조 타입 인스턴스 필드를 `transient`로 선언해야 한다.

* 이펙티브 자바 아이템 90(직렬화된 인스턴스 대신 직렬화 프록시 사용을 검토하라)

  * 제 3자가 확장할 수 없는 클래스라면 가능한 한 직렬화 프록시 패턴을 사용하자. 바깥 클래스의 논리적 상태를 정밀하게 표현하는 중첩 클래스를 설계해 `private static`으로 선언하면 이 클래스가 직렬화 프록시가 된다. 생성자는 단 하나여야 하며, 바깥 클래스를 매개변수로 받아 인수로 넘어온 인스턴스의 데이터를 복사한다. 두 클래스 모두 `Serializable`을 구현한다고 선언 후 바깥 클래스에 `writeReplace`를 추가하여 자바의 직렬화 시스템이 바깥 클래스의 인스턴스 대신 프록시의 인스턴스를 반환하게 한다. 바깥 클래스의 `readObject` 호출 시 에러가 나도록 하게 하면 바깥 클래스의 직렬화된 인스턴스를 생성할 수 없게 된다. 바깥 클래스와 논리적으로 동일한 인스턴스를 반환하는 `readResolve` 메서드를 프록시 클래스에 추가하면 역직렬화 시 직렬화 시스템이 프록시를 다시 바깥 클래스의 인스턴스로 변환하게 해 준다. 프록시 패턴은 일반 인스턴스를 만들 때와 같이 똑같은 생성자, 정적 팩터리, 혹은 다른 메서드들을 사용해 역직렬화된 인스턴스를 생성하게 해 준다.

  

#### 느낀 점

* 여러 이슈로 당분간 휴식을 하려 했지만 이펙티브 자바가 얼마 안 남아서 이것만 하자는 마인드로 하다 보니 또 재미있다. 그렇지만 개발은 마라톤이니까 적절히 머리를 식혀 가며 하는 걸로.......... ;)